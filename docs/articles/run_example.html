<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Running a gene expression meta-analysis of lung cancer subtypes • metapredict</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Running a gene expression meta-analysis of lung cancer subtypes">
<meta property="og:description" content="metapredict">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">metapredict</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/guide.html">Guide to preparing data for a gene expression meta-analysis</a>
    </li>
    <li>
      <a href="../articles/prepare_example.html">Preparing to run a gene expression meta-analysis of lung cancer subtypes</a>
    </li>
    <li>
      <a href="../articles/run_example.html">Running a gene expression meta-analysis of lung cancer subtypes</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/hugheylab/metapredict/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="run_example_files/header-attrs-2.7/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Running a gene expression meta-analysis of lung cancer subtypes</h1>
            
            <h4 class="date">2021-03-11</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/hugheylab/metapredict/blob/master/vignettes/run_example.Rmd"><code>vignettes/run_example.Rmd</code></a></small>
      <div class="hidden name"><code>run_example.Rmd</code></div>

    </div>

    
    
<p>This vignette goes through an example of a gene expression meta-analysis according to the method of <a href="https://doi.org/10.1093/nar/gkv229">Hughey and Butte (2015)</a>. Running this meta-analysis for the first time requires an internet connection, as some SOFT files must be fetched from GEO.</p>
<p>Before running the meta-analysis, you’ll need to download the data and install the custom cdf packages as described at <code><a href="../articles/prepare_example.html">vignette('prepare_example')</a></code>.</p>
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p>The meta-analysis will use data from the following four studies:</p>
<ul>
<li><a href="http://www.broadinstitute.org/cgi-bin/cancer/publications/view/62">Bhattacharjee</a></li>
<li><a href="http://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE11969">GSE11969</a></li>
<li><a href="http://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE29016">GSE29016</a></li>
<li><a href="http://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE30219">GSE30219</a></li>
</ul>
<p>Each study contains samples from various lung cancer subtypes. For this meta-analysis, we are going to train a predictive model for classifying a sample as adenocarcinoma (AD), squamous cell carcinoma (SQ), or small-cell lung carcinoma (SCLC), which will identify a set of genes whose expression varies consisently between subtypes across the multiple studies.</p>
</div>
<div id="set-the-parameters-for-the-meta-analysis" class="section level2">
<h2 class="hasAnchor">
<a href="#set-the-parameters-for-the-meta-analysis" class="anchor"></a>Set the parameters for the meta-analysis</h2>
<p>Open R and set the working directory to the <code>metapredict_example</code> folder that you previously created. Then we’ll load the necessary packages and set the parameters for the meta-analysis. After running the meta-analysis once, you can change <code>denovo</code> to <code>FALSE</code>. In this example, we’re going to use three studies for cross-validation and the fourth as validation.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://r-datatable.com">'data.table'</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://github.com/hugheylab/metapredict">'metapredict'</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://ggplot2.tidyverse.org">'ggplot2'</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st">'RColorBrewer'</span><span class="op">)</span>

<span class="va">parentFolderPath</span> <span class="op">=</span> <span class="st">'expression_data'</span>
<span class="va">expressionDataFile</span> <span class="op">=</span> <span class="st">'expression_data.rds'</span>
<span class="va">denovo</span> <span class="op">=</span> <span class="cn">TRUE</span>

<span class="va">foldidColname</span> <span class="op">=</span> <span class="st">'study'</span>
<span class="va">className</span> <span class="op">=</span> <span class="st">'class'</span>
<span class="va">family</span> <span class="op">=</span> <span class="st">'multinomial'</span>
<span class="va">alpha</span> <span class="op">=</span> <span class="fl">0.9</span>
<span class="va">discoveryStudyNames</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'Bhattacharjee'</span>, <span class="st">'GSE11969'</span>, <span class="st">'GSE29016'</span><span class="op">)</span>
<span class="va">classLevels</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'AD'</span>, <span class="st">'SQ'</span>, <span class="st">'SCLC'</span><span class="op">)</span></code></pre></div>
</div>
<div id="load-the-study-and-sample-metadata" class="section level2">
<h2 class="hasAnchor">
<a href="#load-the-study-and-sample-metadata" class="anchor"></a>Load the study and sample metadata</h2>
<p>For this meta-analysis, the files of study metadata and sample metadata have already been created.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">studyMetadataPath</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">'extdata'</span>, <span class="st">'study_metadata.csv'</span>, package <span class="op">=</span> <span class="st">'metapredict'</span><span class="op">)</span>
<span class="va">studyMetadata</span> <span class="op">=</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/fread.html">fread</a></span><span class="op">(</span><span class="va">studyMetadataPath</span><span class="op">)</span>

<span class="va">sampleMetadataPath</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">'extdata'</span>, <span class="st">'sample_metadata.csv'</span>, package <span class="op">=</span> <span class="st">'metapredict'</span><span class="op">)</span>
<span class="va">sampleMetadata</span> <span class="op">=</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/fread.html">fread</a></span><span class="op">(</span><span class="va">sampleMetadataPath</span><span class="op">)</span></code></pre></div>
</div>
<div id="load-the-gene-expression-data" class="section level2">
<h2 class="hasAnchor">
<a href="#load-the-gene-expression-data" class="anchor"></a>Load the gene expression data</h2>
<p>Now we’ll load the expression data for each study, performing normalization and transformation and mapping probes to genes, where necessary. Running <code>getStudyDataList</code> will take a few minutes.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">if</span> <span class="op">(</span><span class="va">denovo</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">esetList</span> <span class="op">=</span> <span class="fu"><a href="../reference/getStudyDataList.html">getStudyDataList</a></span><span class="op">(</span><span class="va">parentFolderPath</span>, <span class="va">studyMetadata</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">esetList</span>, file <span class="op">=</span> <span class="va">expressionDataFile</span><span class="op">)</span>
<span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
  <span class="va">esetList</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="va">expressionDataFile</span><span class="op">)</span><span class="op">}</span>
<span class="co">#&gt; Loading study Bhattacharjee...</span>
<span class="co">#&gt; Loading required package: hgu95av2hsentrezgcdf</span>
<span class="co">#&gt; Loading required package: AnnotationDbi</span>
<span class="co">#&gt; Loading required package: stats4</span>
<span class="co">#&gt; Loading required package: BiocGenerics</span>
<span class="co">#&gt; Loading required package: parallel</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: 'BiocGenerics'</span>
<span class="co">#&gt; The following objects are masked from 'package:parallel':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     clusterApply, clusterApplyLB, clusterCall, clusterEvalQ,</span>
<span class="co">#&gt;     clusterExport, clusterMap, parApply, parCapply, parLapply,</span>
<span class="co">#&gt;     parLapplyLB, parRapply, parSapply, parSapplyLB</span>
<span class="co">#&gt; The following objects are masked from 'package:stats':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     IQR, mad, sd, var, xtabs</span>
<span class="co">#&gt; The following objects are masked from 'package:base':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     anyDuplicated, append, as.data.frame, basename, cbind, colnames,</span>
<span class="co">#&gt;     dirname, do.call, duplicated, eval, evalq, Filter, Find, get, grep,</span>
<span class="co">#&gt;     grepl, intersect, is.unsorted, lapply, Map, mapply, match, mget,</span>
<span class="co">#&gt;     order, paste, pmax, pmax.int, pmin, pmin.int, Position, rank,</span>
<span class="co">#&gt;     rbind, Reduce, rownames, sapply, setdiff, sort, table, tapply,</span>
<span class="co">#&gt;     union, unique, unsplit, which.max, which.min</span>
<span class="co">#&gt; Loading required package: Biobase</span>
<span class="co">#&gt; Welcome to Bioconductor</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     Vignettes contain introductory material; view with</span>
<span class="co">#&gt;     'browseVignettes()'. To cite Bioconductor, see</span>
<span class="co">#&gt;     'citation("Biobase")', and for packages 'citation("pkgname")'.</span>
<span class="co">#&gt; Loading required package: IRanges</span>
<span class="co">#&gt; Loading required package: S4Vectors</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: 'S4Vectors'</span>
<span class="co">#&gt; The following objects are masked from 'package:data.table':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     first, second</span>
<span class="co">#&gt; The following object is masked from 'package:base':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     expand.grid</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: 'IRanges'</span>
<span class="co">#&gt; The following object is masked from 'package:data.table':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     shift</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Loading study GSE11969...</span>
<span class="co">#&gt; Setting options('download.file.method.GEOquery'='auto')</span>
<span class="co">#&gt; Setting options('GEOquery.inmemory.gpl'=FALSE)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; ── Column specification ────────────────────────────────────────────────────────</span>
<span class="co">#&gt; cols(</span>
<span class="co">#&gt;   .default = col_double()</span>
<span class="co">#&gt; )</span>
<span class="co">#&gt; ℹ Use `spec()` for the full column specifications.</span>
<span class="co">#&gt; File stored at:</span>
<span class="co">#&gt; /var/folders/5g/ksdtq8ws2_980z39rh77bx800000gn/T//RtmpycI0F5/GPL7015.soft</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Loading study GSE29016...</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; ── Column specification ────────────────────────────────────────────────────────</span>
<span class="co">#&gt; cols(</span>
<span class="co">#&gt;   .default = col_double(),</span>
<span class="co">#&gt;   ID_REF = col_character()</span>
<span class="co">#&gt; )</span>
<span class="co">#&gt; ℹ Use `spec()` for the full column specifications.</span>
<span class="co">#&gt; File stored at:</span>
<span class="co">#&gt; /var/folders/5g/ksdtq8ws2_980z39rh77bx800000gn/T//RtmpycI0F5/GPL6947.soft</span>
<span class="co">#&gt; Loading study GSE30219...</span>
<span class="co">#&gt; Loading required package: hgu133plus2hsentrezgcdf</span>
<span class="co">#&gt; </span></code></pre></div>
</div>
<div id="cross-study-normalization-of-discovery-datasets" class="section level2">
<h2 class="hasAnchor">
<a href="#cross-study-normalization-of-discovery-datasets" class="anchor"></a>Cross-study normalization of discovery datasets</h2>
<p>Now we’ll merge the discovery datasets and use ComBat to perform cross-study normalization.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ematList</span> <span class="op">=</span> <span class="fu"><a href="../reference/extractExpressionData.html">extractExpressionData</a></span><span class="op">(</span><span class="va">esetList</span>, <span class="va">sampleMetadata</span><span class="op">)</span>
<span class="va">ematDiscovery</span> <span class="op">=</span> <span class="fu"><a href="../reference/mergeStudyData.html">mergeStudyData</a></span><span class="op">(</span><span class="va">ematList</span><span class="op">[</span><span class="va">discoveryStudyNames</span><span class="op">]</span>, <span class="va">sampleMetadata</span><span class="op">)</span>
<span class="co">#&gt; Found3batches</span>
<span class="co">#&gt; Adjusting for0covariate(s) or covariate level(s)</span>
<span class="co">#&gt; Standardizing Data across genes</span>
<span class="co">#&gt; Fitting L/S model and finding priors</span>
<span class="co">#&gt; Finding parametric adjustments</span>
<span class="co">#&gt; Adjusting the Data</span></code></pre></div>
</div>
<div id="leave-one-study-out-cross-validation" class="section level2">
<h2 class="hasAnchor">
<a href="#leave-one-study-out-cross-validation" class="anchor"></a>Leave-one-study-out cross-validation</h2>
<p>Before running cross-validation, we’ll use the sample metadata to create the <code>weights</code> and <code>foldid</code> vectors that will be passed to <code>cv.glmnet</code>. <code>metapredictCv</code> returns a list, with one element for each value of <code>alpha</code>. Since we’re doing multinomial classification (AD, SQ, and SCLC), <code>cv.glmnet</code> uses the multinomial deviance as the measure of goodness of fit (the lower the better).</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">glmnetArgs</span> <span class="op">=</span> <span class="fu"><a href="../reference/makeGlmnetArgs.html">makeGlmnetArgs</a></span><span class="op">(</span>
  <span class="va">sampleMetadata</span><span class="op">[</span><span class="va">sampleMetadata</span><span class="op">$</span><span class="va">study</span> <span class="op">%in%</span> <span class="va">discoveryStudyNames</span>,<span class="op">]</span>,
  foldidColname <span class="op">=</span> <span class="va">foldidColname</span><span class="op">)</span>

<span class="va">cvFitList</span> <span class="op">=</span> <span class="fu"><a href="../reference/metapredictCv.html">metapredictCv</a></span><span class="op">(</span>
  <span class="va">ematDiscovery</span>, <span class="va">sampleMetadata</span>, yName <span class="op">=</span> <span class="va">className</span>,
  weights <span class="op">=</span> <span class="va">glmnetArgs</span><span class="op">$</span><span class="va">weights</span>, foldid <span class="op">=</span> <span class="va">glmnetArgs</span><span class="op">$</span><span class="va">foldid</span>, alpha <span class="op">=</span> <span class="va">alpha</span>,
  family <span class="op">=</span> <span class="va">family</span>, lambda.min.ratio <span class="op">=</span> <span class="fl">0.001</span>, keep <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">cvFit</span> <span class="op">=</span> <span class="va">cvFitList</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>

<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">cvFit</span><span class="op">)</span></code></pre></div>
<p><img src="run_example_files/figure-html/unnamed-chunk-6-1.png" width="480"></p>
</div>
<div id="coefficients-of-the-best-model-from-cross-validation" class="section level2">
<h2 class="hasAnchor">
<a href="#coefficients-of-the-best-model-from-cross-validation" class="anchor"></a>Coefficients of the best model from cross-validation</h2>
<p>Let’s look at the coefficients for the best model from cross-validation (ignore the warning about “Stacking not well defined…”). This plot shows which genes are used to predict lung cancer subtype. For example, increased expression of any of three keratins (KRT17, KRT5, KRT6A) increases the probability that a sample is SQ. The number in parentheses next to each gene symbol is the Entrez gene ID.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fitResult</span> <span class="op">=</span> <span class="va">cvFit</span><span class="op">$</span><span class="va">glmnet.fit</span>
<span class="va">lambda</span> <span class="op">=</span> <span class="va">cvFit</span><span class="op">$</span><span class="va">lambda.min</span>

<span class="fu"><a href="../reference/plotCoefficients.html">plotCoefficients</a></span><span class="op">(</span><span class="va">fitResult</span>, <span class="va">lambda</span>, classLevels <span class="op">=</span> <span class="va">classLevels</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html">scale_fill_brewer</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">'qual'</span>, palette <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.text.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">8</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="run_example_files/figure-html/unnamed-chunk-7-1.png" width="384"></p>
</div>
<div id="expression-of-selected-genes-in-the-discovery-set" class="section level2">
<h2 class="hasAnchor">
<a href="#expression-of-selected-genes-in-the-discovery-set" class="anchor"></a>Expression of selected genes in the discovery set</h2>
<p>We can also examine the expression of those selected genes in the merged expression data. In this heatmap, hierarchical clustering is used to determine the order of the genes and the order of the samples within each class.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">annoNames</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'study'</span>, <span class="st">'class'</span><span class="op">)</span>
<span class="va">annoLevels</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">discoveryStudyNames</span>, <span class="va">classLevels</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">annoLevels</span><span class="op">)</span> <span class="op">=</span> <span class="va">annoNames</span>
<span class="va">annoColors</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/RColorBrewer/man/ColorBrewer.html">brewer.pal</a></span><span class="op">(</span><span class="fl">3</span>, <span class="st">'Dark2'</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/pkg/RColorBrewer/man/ColorBrewer.html">brewer.pal</a></span><span class="op">(</span><span class="fl">3</span>, <span class="st">'Paired'</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">annoColors</span><span class="op">)</span> <span class="op">=</span> <span class="va">annoNames</span>
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">annoColors</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="op">=</span> <span class="va">annoLevels</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">annoColors</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="op">=</span> <span class="va">annoLevels</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>

<span class="fu"><a href="../reference/plotExpressionHeatmap.html">plotExpressionHeatmap</a></span><span class="op">(</span>
  <span class="va">fitResult</span>, <span class="va">lambda</span>, <span class="va">ematDiscovery</span>, <span class="va">sampleMetadata</span>, <span class="va">annoLevels</span>, <span class="va">annoColors</span>,
  classLevels <span class="op">=</span> <span class="va">classLevels</span>, fontsize_row <span class="op">=</span> <span class="fl">7</span><span class="op">)</span></code></pre></div>
<p><img src="run_example_files/figure-html/unnamed-chunk-8-1.png" width="672"></p>
</div>
<div id="predict-subtype-for-samples-in-the-validation-dataset" class="section level2">
<h2 class="hasAnchor">
<a href="#predict-subtype-for-samples-in-the-validation-dataset" class="anchor"></a>Predict subtype for samples in the validation dataset</h2>
<p>Now we’ll test the model on the last dataset. Internally, <code>metapredict</code> runs <code>mergeStudyData</code> to combine the discovery datasets and the validation dataset, then trains a predictive model on samples from the discovery dataset and predicts the subtype for samples from the validation dataset.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">predsList</span> <span class="op">=</span> <span class="fu"><a href="../reference/metapredict.html">metapredict</a></span><span class="op">(</span>
  <span class="va">ematList</span>, <span class="va">studyMetadata</span>, <span class="va">sampleMetadata</span>, <span class="va">discoveryStudyNames</span>, alpha <span class="op">=</span> <span class="va">alpha</span>,
  lambda <span class="op">=</span> <span class="va">lambda</span>, weights <span class="op">=</span> <span class="va">glmnetArgs</span><span class="op">$</span><span class="va">weights</span>, family <span class="op">=</span> <span class="va">family</span><span class="op">)</span>
<span class="co">#&gt; Found4batches</span>
<span class="co">#&gt; Adjusting for0covariate(s) or covariate level(s)</span>
<span class="co">#&gt; Standardizing Data across genes</span>
<span class="co">#&gt; Fitting L/S model and finding priors</span>
<span class="co">#&gt; Finding parametric adjustments</span>
<span class="co">#&gt; Adjusting the Data</span></code></pre></div>
</div>
<div id="confusion-matrix-for-validation-samples" class="section level2">
<h2 class="hasAnchor">
<a href="#confusion-matrix-for-validation-samples" class="anchor"></a>Confusion matrix for validation samples</h2>
<p>One way to check prediction accuracy of a multinomial classifier is with a confusion matrix. These predictions look pretty good.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/calcConfusionValidation.html">calcConfusionValidation</a></span><span class="op">(</span>
  <span class="va">predsList</span>, lambda <span class="op">=</span> <span class="va">lambda</span>, sampleMetadata <span class="op">=</span> <span class="va">sampleMetadata</span>,
  classLevels <span class="op">=</span> <span class="va">classLevels</span><span class="op">)</span>
<span class="co">#&gt; $GSE30219</span>
<span class="co">#&gt;          predictedClass</span>
<span class="co">#&gt; trueClass AD SQ SCLC</span>
<span class="co">#&gt;      AD   85  0    0</span>
<span class="co">#&gt;      SQ    9 52    0</span>
<span class="co">#&gt;      SCLC  4  0   17</span></code></pre></div>
</div>
<div id="class-probabilities-for-validation-samples" class="section level2">
<h2 class="hasAnchor">
<a href="#class-probabilities-for-validation-samples" class="anchor"></a>Class probabilities for validation samples</h2>
<p>Instead of looking at the single predicted subtype, we can also look at the probabilities for all four subtypes. Both the confusion matrix and this plot suggest that <code>metapredict</code> can combine data from multiple studies to learn an accurate classifier of lung cancer subtype.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plotClassProbsValidation.html">plotClassProbsValidation</a></span><span class="op">(</span>
  <span class="va">predsList</span>, <span class="va">sampleMetadata</span>, <span class="va">className</span>, <span class="va">classLevels</span>, size <span class="op">=</span> <span class="fl">1.5</span>,
  ggplotArgs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html">scale_color_brewer</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">'qual'</span>, palette <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="run_example_files/figure-html/unnamed-chunk-11-1.png" width="672"></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Jake Hughey, Josh Schoenbachler.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
