<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="metapredict">
<title>Running a gene expression meta-analysis of lung cancer subtypes • metapredict</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.0/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.0/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Running a gene expression meta-analysis of lung cancer subtypes">
<meta property="og:description" content="metapredict">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">metapredict</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.1.2</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/guide.html">Guide to preparing data for a gene expression meta-analysis</a>
    <a class="dropdown-item" href="../articles/prepare_example.html">Preparing to run a gene expression meta-analysis of lung cancer subtypes</a>
    <a class="dropdown-item" href="../articles/run_example.html">Running a gene expression meta-analysis of lung cancer subtypes</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://www.hugheylab.org/software/" aria-label="Hughey Lab">Hughey Lab</a>
</li>
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/hugheylab/metapredict/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">



<script src="run_example_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <main id="main"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Running a gene expression meta-analysis of lung cancer subtypes</h1>
            
            <h4 data-toc-skip class="date">2022-05-18</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/hugheylab/metapredict/blob/HEAD/vignettes/run_example.Rmd" class="external-link"><code>vignettes/run_example.Rmd</code></a></small>
      <div class="d-none name"><code>run_example.Rmd</code></div>
    </div>

    
    
<p>This vignette goes through an example of a gene expression meta-analysis according to the method of <a href="https://doi.org/10.1093/nar/gkv229" class="external-link">Hughey and Butte (2015)</a>. Running this meta-analysis for the first time requires an internet connection, as some SOFT files must be fetched from GEO.</p>
<p>Before running the meta-analysis, you’ll need to download the data and install the custom cdf packages as described at <code><a href="../articles/prepare_example.html">vignette('prepare_example')</a></code>.</p>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The meta-analysis will use data from the following four studies:</p>
<ul>
<li><a href="http://www.broadinstitute.org/cgi-bin/cancer/publications/view/62" class="external-link">Bhattacharjee</a></li>
<li><a href="http://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE11969" class="external-link">GSE11969</a></li>
<li><a href="http://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE29016" class="external-link">GSE29016</a></li>
<li><a href="http://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE30219" class="external-link">GSE30219</a></li>
</ul>
<p>Each study contains samples from various lung cancer subtypes. For this meta-analysis, we are going to train a predictive model for classifying a sample as adenocarcinoma (AD), squamous cell carcinoma (SQ), or small-cell lung carcinoma (SCLC), which will identify a set of genes whose expression varies consisently between subtypes across the multiple studies.</p>
</div>
<div class="section level2">
<h2 id="set-the-parameters-for-the-meta-analysis">Set the parameters for the meta-analysis<a class="anchor" aria-label="anchor" href="#set-the-parameters-for-the-meta-analysis"></a>
</h2>
<p>Open R and set the working directory to the <code>metapredict_example</code> folder that you previously created. Then we’ll load the necessary packages and set the parameters for the meta-analysis. After running the meta-analysis once, you can change <code>denovo</code> to <code>FALSE</code>. In this example, we’re going to use three studies for cross-validation and the fourth as validation.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://r-datatable.com" class="external-link">'data.table'</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://metapredict.hugheylab.org">'metapredict'</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://ggplot2.tidyverse.org" class="external-link">'ggplot2'</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st">'RColorBrewer'</span><span class="op">)</span>

<span class="va">parentFolderPath</span> <span class="op">=</span> <span class="st">'expression_data'</span>
<span class="va">expressionDataFile</span> <span class="op">=</span> <span class="st">'expression_data.rds'</span>
<span class="va">denovo</span> <span class="op">=</span> <span class="cn">TRUE</span>

<span class="va">foldidColname</span> <span class="op">=</span> <span class="st">'study'</span>
<span class="va">className</span> <span class="op">=</span> <span class="st">'class'</span>
<span class="va">family</span> <span class="op">=</span> <span class="st">'multinomial'</span>
<span class="va">alpha</span> <span class="op">=</span> <span class="fl">0.9</span>
<span class="va">discoveryStudyNames</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Bhattacharjee'</span>, <span class="st">'GSE11969'</span>, <span class="st">'GSE29016'</span><span class="op">)</span>
<span class="va">classLevels</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'AD'</span>, <span class="st">'SQ'</span>, <span class="st">'SCLC'</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="load-the-study-and-sample-metadata">Load the study and sample metadata<a class="anchor" aria-label="anchor" href="#load-the-study-and-sample-metadata"></a>
</h2>
<p>For this meta-analysis, the files of study metadata and sample metadata have already been created.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">studyMetadataPath</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">'extdata'</span>, <span class="st">'study_metadata.csv'</span>, package <span class="op">=</span> <span class="st">'metapredict'</span><span class="op">)</span>
<span class="va">studyMetadata</span> <span class="op">=</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/fread.html" class="external-link">fread</a></span><span class="op">(</span><span class="va">studyMetadataPath</span><span class="op">)</span>

<span class="va">sampleMetadataPath</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">'extdata'</span>, <span class="st">'sample_metadata.csv'</span>, package <span class="op">=</span> <span class="st">'metapredict'</span><span class="op">)</span>
<span class="va">sampleMetadata</span> <span class="op">=</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/fread.html" class="external-link">fread</a></span><span class="op">(</span><span class="va">sampleMetadataPath</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="load-the-gene-expression-data">Load the gene expression data<a class="anchor" aria-label="anchor" href="#load-the-gene-expression-data"></a>
</h2>
<p>Now we’ll load the expression data for each study, performing normalization and transformation and mapping probes to genes, where necessary. Running <code>getStudyDataList</code> will take a few minutes.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">if</span> <span class="op">(</span><span class="va">denovo</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">esetList</span> <span class="op">=</span> <span class="fu"><a href="../reference/getStudyDataList.html">getStudyDataList</a></span><span class="op">(</span><span class="va">parentFolderPath</span>, <span class="va">studyMetadata</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">esetList</span>, file <span class="op">=</span> <span class="va">expressionDataFile</span><span class="op">)</span>
<span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
  <span class="va">esetList</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="va">expressionDataFile</span><span class="op">)</span><span class="op">}</span>
<span class="co">#&gt; Loading study Bhattacharjee...</span>
<span class="co">#&gt; Loading required package: hgu95av2hsentrezgcdf</span>
<span class="co">#&gt; Loading required package: AnnotationDbi</span>
<span class="co">#&gt; Loading required package: stats4</span>
<span class="co">#&gt; Loading required package: BiocGenerics</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: 'BiocGenerics'</span>
<span class="co">#&gt; The following objects are masked from 'package:stats':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     IQR, mad, sd, var, xtabs</span>
<span class="co">#&gt; The following objects are masked from 'package:base':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     anyDuplicated, append, as.data.frame, basename, cbind, colnames,</span>
<span class="co">#&gt;     dirname, do.call, duplicated, eval, evalq, Filter, Find, get, grep,</span>
<span class="co">#&gt;     grepl, intersect, is.unsorted, lapply, Map, mapply, match, mget,</span>
<span class="co">#&gt;     order, paste, pmax, pmax.int, pmin, pmin.int, Position, rank,</span>
<span class="co">#&gt;     rbind, Reduce, rownames, sapply, setdiff, sort, table, tapply,</span>
<span class="co">#&gt;     union, unique, unsplit, which.max, which.min</span>
<span class="co">#&gt; Loading required package: Biobase</span>
<span class="co">#&gt; Welcome to Bioconductor</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     Vignettes contain introductory material; view with</span>
<span class="co">#&gt;     'browseVignettes()'. To cite Bioconductor, see</span>
<span class="co">#&gt;     'citation("Biobase")', and for packages 'citation("pkgname")'.</span>
<span class="co">#&gt; Loading required package: IRanges</span>
<span class="co">#&gt; Loading required package: S4Vectors</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: 'S4Vectors'</span>
<span class="co">#&gt; The following objects are masked from 'package:data.table':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     first, second</span>
<span class="co">#&gt; The following objects are masked from 'package:base':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     expand.grid, I, unname</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: 'IRanges'</span>
<span class="co">#&gt; The following object is masked from 'package:data.table':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     shift</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Loading study GSE11969...</span>
<span class="co">#&gt; Setting options('download.file.method.GEOquery'='auto')</span>
<span class="co">#&gt; Setting options('GEOquery.inmemory.gpl'=FALSE)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Loading study GSE29016...</span>
<span class="co">#&gt; Loading study GSE30219...</span>
<span class="co">#&gt; Loading required package: hgu133plus2hsentrezgcdf</span>
<span class="co">#&gt; </span></code></pre></div>
</div>
<div class="section level2">
<h2 id="cross-study-normalization-of-discovery-datasets">Cross-study normalization of discovery datasets<a class="anchor" aria-label="anchor" href="#cross-study-normalization-of-discovery-datasets"></a>
</h2>
<p>Now we’ll merge the discovery datasets and use ComBat to perform cross-study normalization.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ematList</span> <span class="op">=</span> <span class="fu"><a href="../reference/extractExpressionData.html">extractExpressionData</a></span><span class="op">(</span><span class="va">esetList</span>, <span class="va">sampleMetadata</span><span class="op">)</span>
<span class="va">ematDiscovery</span> <span class="op">=</span> <span class="fu"><a href="../reference/mergeStudyData.html">mergeStudyData</a></span><span class="op">(</span><span class="va">ematList</span><span class="op">[</span><span class="va">discoveryStudyNames</span><span class="op">]</span>, <span class="va">sampleMetadata</span><span class="op">)</span>
<span class="co">#&gt; Found3batches</span>
<span class="co">#&gt; Adjusting for0covariate(s) or covariate level(s)</span>
<span class="co">#&gt; Standardizing Data across genes</span>
<span class="co">#&gt; Fitting L/S model and finding priors</span>
<span class="co">#&gt; Finding parametric adjustments</span>
<span class="co">#&gt; Adjusting the Data</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="leave-one-study-out-cross-validation">Leave-one-study-out cross-validation<a class="anchor" aria-label="anchor" href="#leave-one-study-out-cross-validation"></a>
</h2>
<p>Before running cross-validation, we’ll use the sample metadata to create the <code>weights</code> and <code>foldid</code> vectors that will be passed to <code>cv.glmnet</code>. <code>metapredictCv</code> returns a list, with one element for each value of <code>alpha</code>. Since we’re doing multinomial classification (AD, SQ, and SCLC), <code>cv.glmnet</code> uses the multinomial deviance as the measure of goodness of fit (the lower the better).</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">glmnetArgs</span> <span class="op">=</span> <span class="fu"><a href="../reference/makeGlmnetArgs.html">makeGlmnetArgs</a></span><span class="op">(</span>
  <span class="va">sampleMetadata</span><span class="op">[</span><span class="va">sampleMetadata</span><span class="op">$</span><span class="va">study</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">discoveryStudyNames</span>,<span class="op">]</span>,
  foldidColname <span class="op">=</span> <span class="va">foldidColname</span><span class="op">)</span>

<span class="va">cvFitList</span> <span class="op">=</span> <span class="fu"><a href="../reference/metapredictCv.html">metapredictCv</a></span><span class="op">(</span>
  <span class="va">ematDiscovery</span>, <span class="va">sampleMetadata</span>, yName <span class="op">=</span> <span class="va">className</span>,
  weights <span class="op">=</span> <span class="va">glmnetArgs</span><span class="op">$</span><span class="va">weights</span>, foldid <span class="op">=</span> <span class="va">glmnetArgs</span><span class="op">$</span><span class="va">foldid</span>, alpha <span class="op">=</span> <span class="va">alpha</span>,
  family <span class="op">=</span> <span class="va">family</span>, lambda.min.ratio <span class="op">=</span> <span class="fl">0.001</span>, keep <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">cvFit</span> <span class="op">=</span> <span class="va">cvFitList</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>

<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">cvFit</span><span class="op">)</span></code></pre></div>
<p><img src="run_example_files/figure-html/unnamed-chunk-6-1.png" width="480"></p>
</div>
<div class="section level2">
<h2 id="coefficients-of-the-best-model-from-cross-validation">Coefficients of the best model from cross-validation<a class="anchor" aria-label="anchor" href="#coefficients-of-the-best-model-from-cross-validation"></a>
</h2>
<p>Let’s look at the coefficients for the best model from cross-validation (ignore the warning about “Stacking not well defined…”). This plot shows which genes are used to predict lung cancer subtype. For example, increased expression of any of three keratins (KRT17, KRT5, KRT6A) increases the probability that a sample is SQ. The number in parentheses next to each gene symbol is the Entrez gene ID.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fitResult</span> <span class="op">=</span> <span class="va">cvFit</span><span class="op">$</span><span class="va">glmnet.fit</span>
<span class="va">lambda</span> <span class="op">=</span> <span class="va">cvFit</span><span class="op">$</span><span class="va">lambda.min</span>

<span class="fu"><a href="../reference/plotCoefficients.html">plotCoefficients</a></span><span class="op">(</span><span class="va">fitResult</span>, <span class="va">lambda</span>, classLevels <span class="op">=</span> <span class="va">classLevels</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html" class="external-link">scale_fill_brewer</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">'qual'</span>, palette <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">8</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; Warning: `guides(&lt;scale&gt; = FALSE)` is deprecated. Please use `guides(&lt;scale&gt; =</span>
<span class="co">#&gt; "none")` instead.</span></code></pre></div>
<p><img src="run_example_files/figure-html/unnamed-chunk-7-1.png" width="384"></p>
</div>
<div class="section level2">
<h2 id="expression-of-selected-genes-in-the-discovery-set">Expression of selected genes in the discovery set<a class="anchor" aria-label="anchor" href="#expression-of-selected-genes-in-the-discovery-set"></a>
</h2>
<p>We can also examine the expression of those selected genes in the merged expression data. In this heatmap, hierarchical clustering is used to determine the order of the genes and the order of the samples within each class.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">annoNames</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'study'</span>, <span class="st">'class'</span><span class="op">)</span>
<span class="va">annoLevels</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">discoveryStudyNames</span>, <span class="va">classLevels</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">annoLevels</span><span class="op">)</span> <span class="op">=</span> <span class="va">annoNames</span>
<span class="va">annoColors</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/RColorBrewer/man/ColorBrewer.html" class="external-link">brewer.pal</a></span><span class="op">(</span><span class="fl">3</span>, <span class="st">'Dark2'</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/pkg/RColorBrewer/man/ColorBrewer.html" class="external-link">brewer.pal</a></span><span class="op">(</span><span class="fl">3</span>, <span class="st">'Paired'</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">annoColors</span><span class="op">)</span> <span class="op">=</span> <span class="va">annoNames</span>
<span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">annoColors</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="op">=</span> <span class="va">annoLevels</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>
<span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">annoColors</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="op">=</span> <span class="va">annoLevels</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>

<span class="fu"><a href="../reference/plotExpressionHeatmap.html">plotExpressionHeatmap</a></span><span class="op">(</span>
  <span class="va">fitResult</span>, <span class="va">lambda</span>, <span class="va">ematDiscovery</span>, <span class="va">sampleMetadata</span>, <span class="va">annoLevels</span>, <span class="va">annoColors</span>,
  classLevels <span class="op">=</span> <span class="va">classLevels</span>, fontsize_row <span class="op">=</span> <span class="fl">7</span><span class="op">)</span>
<span class="co">#&gt; Warning in `[.data.table`(mergeDataTable(colnames(ematMerged),</span>
<span class="co">#&gt; sampleMetadata), : Both 'cols' and '..cols' exist in calling scope. Please</span>
<span class="co">#&gt; remove the '..cols' variable in calling scope for clarity.</span></code></pre></div>
<p><img src="run_example_files/figure-html/unnamed-chunk-8-1.png" width="672"></p>
</div>
<div class="section level2">
<h2 id="predict-subtype-for-samples-in-the-validation-dataset">Predict subtype for samples in the validation dataset<a class="anchor" aria-label="anchor" href="#predict-subtype-for-samples-in-the-validation-dataset"></a>
</h2>
<p>Now we’ll test the model on the last dataset. Internally, <code>metapredict</code> runs <code>mergeStudyData</code> to combine the discovery datasets and the validation dataset, then trains a predictive model on samples from the discovery dataset and predicts the subtype for samples from the validation dataset.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">predsList</span> <span class="op">=</span> <span class="fu"><a href="../reference/metapredict.html">metapredict</a></span><span class="op">(</span>
  <span class="va">ematList</span>, <span class="va">studyMetadata</span>, <span class="va">sampleMetadata</span>, <span class="va">discoveryStudyNames</span>, alpha <span class="op">=</span> <span class="va">alpha</span>,
  lambda <span class="op">=</span> <span class="va">lambda</span>, weights <span class="op">=</span> <span class="va">glmnetArgs</span><span class="op">$</span><span class="va">weights</span>, family <span class="op">=</span> <span class="va">family</span><span class="op">)</span>
<span class="co">#&gt; Found4batches</span>
<span class="co">#&gt; Adjusting for0covariate(s) or covariate level(s)</span>
<span class="co">#&gt; Standardizing Data across genes</span>
<span class="co">#&gt; Fitting L/S model and finding priors</span>
<span class="co">#&gt; Finding parametric adjustments</span>
<span class="co">#&gt; Adjusting the Data</span>
<span class="co">#&gt; Warning in `[.data.table`(yDTM, , ..className): Both 'className' and</span>
<span class="co">#&gt; '..className' exist in calling scope. Please remove the '..className' variable</span>
<span class="co">#&gt; in calling scope for clarity.</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="confusion-matrix-for-validation-samples">Confusion matrix for validation samples<a class="anchor" aria-label="anchor" href="#confusion-matrix-for-validation-samples"></a>
</h2>
<p>One way to check prediction accuracy of a multinomial classifier is with a confusion matrix. These predictions look pretty good.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/calcConfusionValidation.html">calcConfusionValidation</a></span><span class="op">(</span>
  <span class="va">predsList</span>, lambda <span class="op">=</span> <span class="va">lambda</span>, sampleMetadata <span class="op">=</span> <span class="va">sampleMetadata</span>,
  classLevels <span class="op">=</span> <span class="va">classLevels</span><span class="op">)</span>
<span class="co">#&gt; $GSE30219</span>
<span class="co">#&gt;          predictedClass</span>
<span class="co">#&gt; trueClass AD SQ SCLC</span>
<span class="co">#&gt;      AD   85  0    0</span>
<span class="co">#&gt;      SQ    9 52    0</span>
<span class="co">#&gt;      SCLC  4  0   17</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="class-probabilities-for-validation-samples">Class probabilities for validation samples<a class="anchor" aria-label="anchor" href="#class-probabilities-for-validation-samples"></a>
</h2>
<p>Instead of looking at the single predicted subtype, we can also look at the probabilities for all four subtypes. Both the confusion matrix and this plot suggest that <code>metapredict</code> can combine data from multiple studies to learn an accurate classifier of lung cancer subtype.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plotClassProbsValidation.html">plotClassProbsValidation</a></span><span class="op">(</span>
  <span class="va">predsList</span>, <span class="va">sampleMetadata</span>, <span class="va">className</span>, <span class="va">classLevels</span>, size <span class="op">=</span> <span class="fl">1.5</span>,
  ggplotArgs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html" class="external-link">scale_color_brewer</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">'qual'</span>, palette <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="run_example_files/figure-html/unnamed-chunk-11-1.png" width="672"></p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Jake Hughey, Josh Schoenbachler.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.3.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
